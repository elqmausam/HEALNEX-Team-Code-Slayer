# Makefile
# Simplified commands for Hospital Agent Docker management

.PHONY: help build up down restart logs health test clean

# Default target
help:
	@echo "Hospital Agent - Docker Management"
	@echo "=================================="
	@echo ""
	@echo "Available commands:"
	@echo "  make setup      - Initial setup (build and start)"
	@echo "  make up         - Start all services"
	@echo "  make down       - Stop all services"
	@echo "  make restart    - Restart all services"
	@echo "  make logs       - View logs (follow mode)"
	@echo "  make health     - Check service health"
	@echo "  make test       - Run API tests"
	@echo "  make clean      - Stop and remove all containers/volumes"
	@echo "  make rebuild    - Rebuild and restart"
	@echo "  make shell      - Open shell in app container"
	@echo "  make db         - Connect to PostgreSQL"
	@echo "  make redis      - Connect to Redis CLI"
	@echo ""

# Initial setup
setup:
	@echo "üöÄ Setting up Hospital Agent..."
	@chmod +x scripts/docker-setup.sh
	@./scripts/docker-setup.sh

# Build images
build:
	@echo "üî® Building Docker images..."
	@docker-compose build

# Start services
up:
	@echo "‚ñ∂Ô∏è  Starting services..."
	@docker-compose up -d
	@echo "‚úÖ Services started!"
	@echo "üì° API: http://localhost:8000/docs"

# Start with debug tools
debug:
	@echo "üêõ Starting with debug tools..."
	@docker-compose --profile debug up -d
	@echo "‚úÖ Services started with debug tools!"
	@echo "üìä Redis Commander: http://localhost:8081"
	@echo "üóÑÔ∏è  pgAdmin: http://localhost:5050"

# Start with monitoring
monitor:
	@echo "üìà Starting with monitoring..."
	@docker-compose --profile monitoring up -d
	@echo "‚úÖ Services started with monitoring!"
	@echo "üìä Prometheus: http://localhost:9090"
	@echo "üìà Grafana: http://localhost:3000"

# Stop services
down:
	@echo "‚èπÔ∏è  Stopping services..."
	@docker-compose down
	@echo "‚úÖ Services stopped!"

# Restart services
restart:
	@echo "üîÑ Restarting services..."
	@docker-compose restart
	@echo "‚úÖ Services restarted!"

# View logs
logs:
	@docker-compose logs -f

# View logs for specific service
logs-app:
	@docker-compose logs -f hospital-agent

# Check health
health:
	@echo "üè• Checking service health..."
	@echo ""
	@echo "Redis:"
	@docker-compose exec -T redis redis-cli ping || echo "‚ùå Redis not responding"
	@echo ""
	@echo "PostgreSQL:"
	@docker-compose exec -T postgres pg_isready -U postgres || echo "‚ùå PostgreSQL not responding"
	@echo ""
	@echo "Hospital Agent:"
	@curl -s http://localhost:8000/health | jq || echo "‚ùå App not responding"
	@echo ""

# Run tests
test:
	@echo "üß™ Running tests..."
	@curl -s -X POST http://localhost:8000/api/v1/chat/message \
		-H "Content-Type: application/json" \
		-d '{"message":"Hello","hospital_id":"H001"}' | jq
	@echo ""
	@echo "Testing FREE APIs..."
	@curl -s "http://localhost:8000/api/v1/demo/H001/simple?location=Mumbai" | jq

# Clean everything
clean:
	@echo "üßπ Cleaning up..."
	@docker-compose down -v
	@echo "‚úÖ Cleanup complete!"

# Rebuild and restart
rebuild:
	@echo "üî® Rebuilding..."
	@docker-compose build --no-cache
	@docker-compose up -d
	@echo "‚úÖ Rebuild complete!"

# Open shell in app container
shell:
	@docker-compose exec hospital-agent /bin/bash

# Connect to PostgreSQL
db:
	@docker-compose exec postgres psql -U postgres -d hospital_agent

# Connect to Redis
redis:
	@docker-compose exec redis redis-cli

# Show status
status:
	@echo "üìä Container Status:"
	@docker-compose ps
	@echo ""
	@echo "üíæ Volume Usage:"
	@docker volume ls | grep hospital

# Backup database
backup:
	@echo "üíæ Creating database backup..."
	@mkdir -p backups
	@docker-compose exec -T postgres pg_dump -U postgres hospital_agent > backups/backup_$(shell date +%Y%m%d_%H%M%S).sql
	@echo "‚úÖ Backup created in backups/"

# Restore database
restore:
	@echo "‚ö†Ô∏è  This will restore the database from the latest backup"
	@read -p "Continue? [y/N] " -n 1 -r; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		docker-compose exec -T postgres psql -U postgres hospital_agent < backups/$(shell ls -t backups/*.sql | head -1); \
		echo "‚úÖ Database restored"; \
	fi

# Update .env
env:
	@nano .env

# Show URLs
urls:
	@echo "üì° Access Points:"
	@echo "  API Docs:    http://localhost:8000/docs"
	@echo "  Health:      http://localhost:8000/health"
	@echo "  Redis:       localhost:6379"
	@echo "  PostgreSQL:  localhost:5432"
	@echo ""
	@echo "üß™ Test Endpoints:"
	@echo "  Demo:        http://localhost:8000/api/v1/demo/H001?location=Mumbai"
	@echo "  Mock HMIS:   http://localhost:8000/api/v1/mock/hmis/"
	@echo "  Mock Lab:    http://localhost:8000/api/v1/mock/lab/"